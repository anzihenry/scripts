#!/bin/zsh
# filepath: setup/ohmyzsh-setup.sh

# å¯ç”¨é”™è¯¯ä¸­æ–­å’Œæ˜¾ç¤ºæ‰§è¡Œå‘½ä»¤
set -e
set -o pipefail

# å¼•å…¥é¢œè‰²åº“
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/../lib/colors.sh"

# ===== Xcode CLI å·¥å…·å®‰è£… =====
install_xcode_cli() {
    print_header "æ­¥éª¤ 0: æ£€æŸ¥/å®‰è£… Xcode å‘½ä»¤è¡Œå·¥å…·"
    
    if ! xcode-select -p &>/dev/null; then
        warning "æ­£åœ¨å®‰è£… Xcode CLI å·¥å…·... è¯·åœ¨å¼¹å‡ºçš„çª—å£ä¸­å®Œæˆå®‰è£…ã€‚"
        xcode-select --install
        
        # ä½¿ç”¨å›ºå®šçš„è½®è¯¢é—´éš”ç­‰å¾…å®‰è£…å®Œæˆ
        local wait_count=0
        local max_wait=60 # æœ€å¤šç­‰å¾… 60 * 5 = 300 ç§’
        until xcode-select -p &>/dev/null; do
            info "ç­‰å¾… Xcode CLI å®‰è£…å®Œæˆ... (${wait_count}/${max_wait})"
            sleep 5
            ((wait_count++))
            [[ $wait_count -gt $max_wait ]] && log_fatal "å®‰è£…è¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨æ‰§è¡Œ: xcode-select --install"
        done
        
        # éªŒè¯ç¼–è¯‘å™¨å­˜åœ¨
        [[ -f /usr/bin/clang ]] || log_fatal "CLI å·¥å…·å®‰è£…ä¸å®Œæ•´"
    fi
    success "Xcode å‘½ä»¤è¡Œå·¥å…·å°±ç»ª"
}

# ===== Oh My Zsh å®‰è£… =====
install_oh_my_zsh() {
    print_header "æ­¥éª¤ 1: å®‰è£… Oh My Zsh"
    
    OHMYZSH_DIR="${HOME}/.oh-my-zsh"
    if [ ! -d "${OHMYZSH_DIR}" ]; then
        info "æ­£åœ¨å®‰è£… oh-my-zsh..."
        
        # ä¼˜å…ˆå°è¯• GitHub å®˜æ–¹æºï¼Œå¤±è´¥åˆ™å›é€€åˆ° Gitee
        if ! git clone https://github.com/ohmyzsh/ohmyzsh.git "${OHMYZSH_DIR}"; then
            warning "GitHub è¿æ¥å¤±è´¥ï¼Œæ”¹ç”¨ Gitee é•œåƒ..."
            git clone https://gitee.com/mirrors/oh-my-zsh.git "${OHMYZSH_DIR}" || log_fatal "Oh My Zsh å®‰è£…å¤±è´¥"
        fi

        # å¤‡ä»½åŸæœ‰é…ç½®
        if [ -f "${HOME}/.zshrc" ]; then
            cp "${HOME}/.zshrc" "${HOME}/.zshrc.bak.$(date +%Y%m%d_%H%M%S)"
            warning "å·²å¤‡ä»½åŸæœ‰é…ç½®åˆ° ~/.zshrc.bak.*"
        fi

        # åº”ç”¨åŸºç¡€é…ç½®æ¨¡æ¿
        cp "${OHMYZSH_DIR}/templates/zshrc.zsh-template" "${HOME}/.zshrc"
        success "Oh My Zsh å®‰è£…å®Œæˆ"
    else
        success "Oh My Zsh å·²å®‰è£…"
    fi
}

# ===== Powerlevel10k ä¸»é¢˜å®‰è£… =====
install_p10k_theme() {
    print_header "æ­¥éª¤ 2: å®‰è£… Powerlevel10k ä¸»é¢˜"
    
    P10K_DIR="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k"
    
    # æ¸…ç†æ—§ç‰ˆæœ¬ä»¥ç¡®ä¿å…¨æ–°å®‰è£…
    [ -d "${P10K_DIR}" ] && rm -rf "${P10K_DIR}"
    
    info "æ­£åœ¨å®‰è£… powerlevel10k ä¸»é¢˜..."
    if ! git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "${P10K_DIR}"; then
        warning "GitHub è¿æ¥å¤±è´¥ï¼Œæ”¹ç”¨ Gitee é•œåƒ..."
        git clone --depth=1 https://gitee.com/romkatv/powerlevel10k.git "${P10K_DIR}" || log_fatal "Powerlevel10k ä¸»é¢˜å®‰è£…å¤±è´¥"
    fi
    success "Powerlevel10k ä¸»é¢˜å·²å®‰è£…"
}

# ===== æ ¸å¿ƒæ’ä»¶å®‰è£… =====
install_plugins() {
    print_header "æ­¥éª¤ 3: å®‰è£…æ ¸å¿ƒæ’ä»¶"
    
    ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
    
    # æ’ä»¶å®‰è£…å‡½æ•°
    _install_plugin() {
        local name="$1" repo_gh="$2" repo_ge="$3"
        local plugin_dir="${ZSH_CUSTOM}/plugins/${name}"
        if [ ! -d "${plugin_dir}" ]; then
            info "å®‰è£…æ’ä»¶ ${name}..."
            if ! git clone --depth=1 "https://github.com/${repo_gh}.git" "${plugin_dir}"; then
                warning "GitHub è¿æ¥å¤±è´¥ï¼Œæ”¹ç”¨ Gitee é•œåƒ..."
                git clone --depth=1 "https://gitee.com/${repo_ge}.git" "${plugin_dir}" || warning "æ’ä»¶ ${name} å®‰è£…å¤±è´¥"
            fi
        fi
    }
    
    _install_plugin "zsh-syntax-highlighting" "zsh-users/zsh-syntax-highlighting" "mirrors/zsh-syntax-highlighting"
    _install_plugin "zsh-autosuggestions" "zsh-users/zsh-autosuggestions" "mirrors/zsh-autosuggestions"
    
    success "æ ¸å¿ƒæ’ä»¶æ£€æŸ¥/å®‰è£…å®Œæˆ"
}

# ===== .zshrc é…ç½®æ–‡ä»¶æ›´æ–° =====
update_zsh_config() {
    print_header "æ­¥éª¤ 4: æ›´æ–° .zshrc é…ç½®æ–‡ä»¶"

    local theme="powerlevel10k/powerlevel10k"
    # å®šä¹‰ä¸€ä¸ªå›ºå®šçš„ã€å®Œæ•´çš„æ’ä»¶åˆ—è¡¨
    local plugins_str="git extract z colored-man-pages zsh-syntax-highlighting zsh-autosuggestions"
    
    # ä½¿ç”¨ä¸€ä¸ªæ ‡è®°æ¥ç®¡ç†æ•´ä¸ªé…ç½®å—
    local section="Oh My Zsh & P10k"
    local marker="# >>> ${section} (generated by script) >>>"
    local end_marker="# <<< ${section} (generated by script) <<<"

    # 1. å¦‚æœå­˜åœ¨æ—§çš„é…ç½®å—ï¼Œå…ˆåˆ é™¤
    if grep -q "$marker" ~/.zshrc; then
        sed -i '' "/$marker/,/$end_marker/d" ~/.zshrc
    fi

    # 2. å¦‚æœå­˜åœ¨æ—§çš„ã€éè„šæœ¬ç®¡ç†çš„ä¸»é¢˜å’Œæ’ä»¶è¡Œï¼Œæ³¨é‡Šæ‰å®ƒä»¬ä»¥é¿å…å†²çª
    sed -i '' -E 's/^ZSH_THEME=/# &/' ~/.zshrc
    sed -i '' -E 's/^plugins=\(.*\)/# &/' ~/.zshrc

    # 3. è¿½åŠ æ–°çš„ã€å®Œæ•´çš„é…ç½®å—
    cat >> ~/.zshrc <<-EOF

$marker
# Oh My Zsh ä¸»é¢˜
ZSH_THEME="${theme}"

# Oh My Zsh æ’ä»¶
plugins=($plugins_str)

# Powerlevel10k ä¼˜åŒ–é…ç½®
# ç¦ç”¨åˆæ¬¡å¯åŠ¨çš„é…ç½®å‘å¯¼
# POWERLEVEL9K_DISABLE_CONFIGURATION_WIZARD=true
# æç¤ºç¬¦å…ƒç´ é…ç½®
POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(dir vcs status)
POWERLEVEL9K_RIGHT_PROMPT_ELEMENTS=(time background_jobs)
POWERLEVEL9K_MODE='nerdfont-complete'
$end_marker
EOF
    success ".zshrc é…ç½®å·²æ›´æ–°"
}

# ===== å­—ä½“å®‰è£… =====
install_fonts() {
    print_header "æ­¥éª¤ 5: å®‰è£… Powerline å­—ä½“"
    
    declare -A fonts=(
        ["MesloLGS NF Regular.ttf"]="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Regular.ttf"
        ["MesloLGS NF Bold.ttf"]="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Bold.ttf"
        ["MesloLGS NF Italic.ttf"]="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Italic.ttf"
        ["MesloLGS NF Bold Italic.ttf"]="https://github.com/romkatv/powerlevel10k-media/raw/master/MesloLGS%20NF%20Bold%20Italic.ttf"
    )
    
    FONT_DIR="${HOME}/Library/Fonts"
    mkdir -p "${FONT_DIR}"
    
    for font in ${(k)fonts}; do
        if [ ! -f "${FONT_DIR}/${font}" ]; then
            info "ä¸‹è½½å­—ä½“: ${font}..."
            if ! curl -#L -o "${FONT_DIR}/${font}" "${fonts[$font]}"; then
                warning "å­—ä½“ ${font} ä¸‹è½½å¤±è´¥ï¼"
                info "è¯·å°è¯•æ‰‹åŠ¨ä»ä»¥ä¸‹åœ°å€ä¸‹è½½å¹¶æ”¾å…¥ ~/Library/Fonts/ ç›®å½•ï¼š"
                info "${fonts[$font]}"
            fi
        fi
    done
    
    # åˆ·æ–°å­—ä½“ç¼“å­˜
    sudo atsutil databases -remove &>/dev/null || true
    
    success "å­—ä½“æ£€æŸ¥/å®‰è£…å®Œæˆ"
}

# ===== æœ€ç»ˆæŒ‡å¼• =====
final_instructions() {
    print_header "ğŸ‰ é…ç½®å®Œæˆï¼è¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œ"
    
    info "1. ${BOLD}è®¾ç½®ç»ˆç«¯å­—ä½“:${NC}"
    info "   - iTerm2: Preferences â†’ Profiles â†’ Text â†’ Font â†’ é€‰æ‹© $(highlight 'MesloLGS NF')"
    info "   - VSCode: è®¾ç½®ä¸­æœç´¢ $(highlight 'terminal.integrated.fontFamily') â†’ æ·»åŠ  $(highlight 'MesloLGS NF')"
    
    info "2. ${BOLD}è¿è¡Œä¸»é¢˜é…ç½®å‘å¯¼:${NC}"
    info "   åœ¨ç»ˆç«¯ä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œæ ¹æ®ä¸ªäººå–œå¥½è¿›è¡Œé…ç½®ï¼š"
    print_code "p10k configure"
    
    info "3. ${BOLD}å®Œå…¨åˆ·æ–° Shell:${NC}"
    info "   æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ä»¥åŠ è½½æ‰€æœ‰æ–°é…ç½®ï¼š"
    print_code "exec zsh"
}

# ===== ä¸»æ‰§è¡Œæµç¨‹ =====
main() {
    install_xcode_cli
    install_oh_my_zsh
    install_p10k_theme
    install_plugins
    update_zsh_config
    install_fonts
    final_instructions
}

# å¯åŠ¨ä¸»æµç¨‹
main