---
applyTo: "**/*.sh"
description: "Shell 脚本通用规范"
---
# Shell 脚本通用指南

> 按需复制本指南并更新占位符，如与目录专用说明冲突，请以更细粒度的说明为准。

## 背景与目标
- 背景：仓库聚焦 macOS 14+ 的自动化脚本，既包含初始化流程也覆盖日常维护任务。
- 目标：
	- 生成/修改脚本时保持幂等，支持重复执行与显式的 `--force` 等开关。
	- 输出统一的彩色日志，便于定位执行步骤与耗时。
	- 代码易读、易测，方便在 Bash 与 Zsh 之间迁移。

## 适用范围
- 文件/目录：所有 `*.sh` 文件（包含 `setup/`、`maintain/`、`lint/` 等）。
- 关键约束：
	- macOS 版本：兼容 macOS 14 及以上系统自带工具。
	- Shell 类型：根据现有脚本 shebang 选择 `bash` (macOS 3.2) 或 `zsh`，保持兼容。 
	- 权限限制：默认以普通用户执行，如需 `sudo` 必须先提醒风险。

## 代码风格要求
### 头部与基础设置
- Shebang：保留原 shebang；新文件按目录指引选择 `#!/bin/bash` 或 `#!/bin/zsh`，并补充 `# filepath: ...`。
- 严格模式：默认启用 `set -euo pipefail`（Bash 3.x 不支持 `-o pipefail` 时需解释并提供替代处理）。临时关闭严格模式需注释原因并及时恢复。

### 日志与输出
- 统一引入：`source "$SCRIPT_DIR/../lib/colors.sh"` 或等效相对路径。
- 日志函数：使用 `print_header`、`info`、`success`、`warning`、`error`、`highlight`、`log_time_start`、`log_time_end` 等库函数。
- 输出语言：描述信息使用中文，命令、文件名或关键字保持英文。

### 命名规范
- 函数命名：小写 + 下划线，例如 `run_task()`。
- 局部变量：使用 `local` 限定作用域，避免污染全局。
- 常量/数组：使用全大写或明确前缀，如 `EXCLUDED_ITEMS`、`FORMULAE_LIST`。

## 功能与结构约束
### 依赖检测
- 在执行前使用 `command -v <依赖>` 或自定义检测函数，缺失时输出解决建议并返回非零状态。

### 参数与开关
- 列出支持的参数（如 `--force`、`--dry-run`、`--yes`），为易错选项提供默认值或确认提示。
- 幂等保障：在写入、安装或删除前检查资源状态，提供跳过或强制执行分支。

### 复用组件
- 优先复用仓库现有库（如 `lib/colors.sh`、`setup/lib/brew_helpers.sh`）。
- 不重复造轮子：若已有函数可满足需求，应通过引入共享库或提取公共逻辑。

## 错误处理与提示
- 异常输出：失败情形调用 `error` 提示并说明下一步（重试、手动修复等），必要时写入日志文件。
- 重试逻辑：对于网络或安装命令，可结合 `setup/lib/brew_helpers.sh` 的重试方法；若自定义重试，需给出最大次数与等待策略。
- 长耗时任务：提供进度提示（当前步骤/总步骤），必要时记录耗时或指引用户保持终端激活。

## 验证与交付
- 语法检查：根据 shebang 运行 `zsh -n <script>` 或 `bash -n <script>`。
- Lint：使用 `./lint/lint_shell.sh`（必要时追加 `--fix`）。
- 其他：根据脚本职能补充手动验证或回归步骤。

## 推荐 Prompt
- “在遵循《Shell 脚本通用指南》的前提下，为 `<路径>` 新增脚本，支持参数 ...。”
- “请根据通用指南为 `<函数>` 添加依赖检测与幂等处理，日志使用颜色库。”
- “根据指南优化 `<文件>` 的错误处理，确保失败路径记录日志并返回非零状态。”

## 维护说明
- 负责人：脚本仓库维护者（见 `README` 贡献指南）。
- 更新频率：每季度与目录专项说明同步复查。
- 历史记录：重大变更请在 PR 描述与变更日志中说明。
